{"version":3,"file":"DvipdfmxEngine-Hun86ZVO.js","sources":["../../src/engines/DvipdfmxEngine.ts"],"sourcesContent":["/**\n * Dvipdfmx Engine Wrapper for HeyTeX\n * Converts XDV files to PDF\n */\n\ndeclare const DvipdfmxEngine: any;\n\nexport class DvipdfmxEngineWrapper {\n    private engine: any;\n    private texliveEndpoint: string = '';\n\n    async initialize(): Promise<void> {\n        // Load the DvipdfmxEngine script\n        if (typeof DvipdfmxEngine === 'undefined') {\n            await this.loadScript('/core/swiftlatex/DvipdfmxEngine.js');\n            await this.loadScript('/core/swiftlatex/TexlyreDvipdfmxEngineSetup.js');\n        }\n\n        this.engine = new (window as any).DvipdfmxEngine();\n        await this.engine.loadEngine();\n        \n        if (this.texliveEndpoint) {\n            this.engine.setTexliveEndpoint(this.texliveEndpoint);\n        }\n    }\n\n    private loadScript(src: string): Promise<void> {\n        return new Promise((resolve, reject) => {\n            const script = document.createElement('script');\n            script.src = src;\n            script.onload = () => resolve();\n            script.onerror = reject;\n            document.head.appendChild(script);\n        });\n    }\n\n    async convertXdvToPdf(xdvData: Uint8Array, filename: string = 'main.xdv', fonts?: Record<string, ArrayBuffer>): Promise<Uint8Array> {\n        // Create a fresh engine instance to avoid font cache issues\n        // This fixes: \"Assertion failed: font_cache.fonts == NULL\"\n        const freshEngine = new (window as any).DvipdfmxEngine();\n        await freshEngine.loadEngine();\n        \n        if (this.texliveEndpoint) {\n            freshEngine.setTexliveEndpoint(this.texliveEndpoint);\n        }\n\n        // Create /tex directory for font files\n        try {\n            await freshEngine.makeMemFSFolder('/tex');\n        } catch (e) {\n            // Directory might already exist\n        }\n\n        // Copy fonts to fresh engine's MemFS if provided\n        if (fonts) {\n            for (const [path, content] of Object.entries(fonts)) {\n                await freshEngine.writeMemFSFile(path, new Uint8Array(content));\n            }\n        }\n\n        // Write XDV file to MemFS\n        await freshEngine.writeMemFSFile(`/work/${filename}`, xdvData);\n        await freshEngine.setEngineMainFile(filename);\n\n        // Convert to PDF\n        const result = await freshEngine.compilePDF();\n\n        if (result.status === 0 && result.pdf) {\n            return result.pdf;\n        }\n\n        throw new Error(`PDF conversion failed: ${result.log || 'Unknown error'}`);\n    }\n\n    setTexliveEndpoint(url: string): void {\n        this.texliveEndpoint = url;\n        if (this.engine) {\n            this.engine.setTexliveEndpoint(url);\n        }\n    }\n}\n"],"names":["DvipdfmxEngineWrapper","__publicField","src","resolve","reject","script","xdvData","filename","fonts","freshEngine","path","content","result","url"],"mappings":"oKAOO,MAAMA,CAAsB,CAA5B,cACKC,EAAA,eACAA,EAAA,uBAA0B,IAElC,MAAM,YAA4B,CAE1B,OAAO,eAAmB,MAC1B,MAAM,KAAK,WAAW,oCAAoC,EAC1D,MAAM,KAAK,WAAW,gDAAgD,GAG1E,KAAK,OAAS,IAAK,OAAe,eAClC,MAAM,KAAK,OAAO,WAAA,EAEd,KAAK,iBACL,KAAK,OAAO,mBAAmB,KAAK,eAAe,CAE3D,CAEQ,WAAWC,EAA4B,CAC3C,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CACpC,MAAMC,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,IAAMH,EACbG,EAAO,OAAS,IAAMF,EAAA,EACtBE,EAAO,QAAUD,EACjB,SAAS,KAAK,YAAYC,CAAM,CACpC,CAAC,CACL,CAEA,MAAM,gBAAgBC,EAAqBC,EAAmB,WAAYC,EAA0D,CAGhI,MAAMC,EAAc,IAAK,OAAe,eACxC,MAAMA,EAAY,WAAA,EAEd,KAAK,iBACLA,EAAY,mBAAmB,KAAK,eAAe,EAIvD,GAAI,CACA,MAAMA,EAAY,gBAAgB,MAAM,CAC5C,MAAY,CAEZ,CAGA,GAAID,EACA,SAAW,CAACE,EAAMC,CAAO,IAAK,OAAO,QAAQH,CAAK,EAC9C,MAAMC,EAAY,eAAeC,EAAM,IAAI,WAAWC,CAAO,CAAC,EAKtE,MAAMF,EAAY,eAAe,SAASF,CAAQ,GAAID,CAAO,EAC7D,MAAMG,EAAY,kBAAkBF,CAAQ,EAG5C,MAAMK,EAAS,MAAMH,EAAY,WAAA,EAEjC,GAAIG,EAAO,SAAW,GAAKA,EAAO,IAC9B,OAAOA,EAAO,IAGlB,MAAM,IAAI,MAAM,0BAA0BA,EAAO,KAAO,eAAe,EAAE,CAC7E,CAEA,mBAAmBC,EAAmB,CAClC,KAAK,gBAAkBA,EACnB,KAAK,QACL,KAAK,OAAO,mBAAmBA,CAAG,CAE1C,CACJ"}